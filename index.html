<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
		<!--width=device-width為適應各式裝置螢幕大小 initial-scale=1為初始比例-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge"> 
		<!--X-UA-Compatible設置IE兼容模式；有什麼最新的版本IE，就用什麼版本的標準模式。-->
		<title>REACT TEST</title>
    </head>
	<body>
        <div id="example">
        </div><hr/>
		<div id="container_1">
		</div><hr/>
		<div id="container_2">
		</div><hr/>
		<div id="container_3">
		</div><hr/>
        <div id="container_4">
        </div><hr/>
        <div id="container_5">
        </div><hr/>
        <div id="container_6">
        </div><hr/>
        <div id="container_7">
        </div><hr/>
        <div id="container_8">
        </div><hr/>
	</body>
	<!--因為要先等DOM生成完畢，才開始製作組建，也可以使用jQ的ready，就不用放在下面了-->
	<script src="https://fb.me/react-0.14.7.js"></script>
   	<script src="https://fb.me/react-dom-0.14.7.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/showdown/0.3.1/showdown.min.js"></script>
    <script src="jquery-2.2.0.min.js"></script>

	<script  type="text/babel">
        var HelloWorld = React.createClass({
            getInitialState: function(){
                return{
                    userName: "預設姓名"
                }
            },
            handleChange: function(){
                this.setState({
                    userName: this.refs.userName.value
                })
            },
            render: function(){
                return(
                    <p>
                    <input type="text" placeholder="你的名子" ref="userName" onChange={this.handleChange}/>
                    Hello, 【{this.state.userName}】!
                    It is {this.props.date.toTimeString()}
                    </p>
               );
            }
        });

        setInterval(function(){
            ReactDOM.render(<HelloWorld date={new Date()}/>, document.getElementById("example"));
        }, 500)

    	var Timer = React.createClass({
    		getInitialState: function(){
    			return {secondsElapsed: 0};
    		},
    		tick: function(){
    			this.setState({secondsElapsed: this.state.secondsElapsed + 1});
    		},
    		componentDidMount: function(){ //DOM建立時自動執行的
    			this.interval = setInterval(this.tick, 1000);
    		},
    		componentWillUnmount: function(){ //DOM卸載時自動執行的
    			clearInterval(this.interval);
    		},
    		render: function(){
    			return(
    				<div>Seconds Elapsed:{this.state.secondsElapsed}</div>
    			);
    		}
    	})

    	ReactDOM.render(<Timer />, document.getElementById('container_1'))

    	var TodoList = React.createClass({
    		render: function(){
    			var createItem = function(itemText){
    				return(
    					<li>{itemText}</li>
    				);
    			};
		    	return(
					<ul>{this.props.items.map(createItem)}</ul>
				);
    		}
    	});
    	var TodoApp = React.createClass({
    		getInitialState: function(){
    			return {items:["預設第一個ToDo"], text:"預設值"};
    		},
    		onChange: function(e){
    			this.setState({text: e.target.value});
    		},
    		handleSubmit: function(e){
    			e.preventDefault();
    			var nextItems = this.state.items.concat([this.state.text]);
    			var nextText = "";
    			this.setState({items:nextItems, text:nextText})
    		},
    		render: function(){
    			return(
    				<div>
	    				<h3>ToDo</h3>
	    				<TodoList items={this.state.items}/>
	    				<form onSubmit={this.handleSubmit}>
	    					<input onChange={this.onChange} value={this.state.text}/>
	    					<button>{"Add#"+ (this.state.items.length+1)}</button>
	    				</form>
    				</div>
    			)
    		}
    	});

    	React.render(<TodoApp />, document.getElementById("container_2"))


		var CommentBox = React.createClass({
			loadCommentsFromServer: function(){
				$.ajax({
					url: this.props.url,
					dataType: "json",
					success: function(data){
						this.setState({data:data})
					}.bind(this),
					error: function(xhr, status, err){
						console.error(this.props.url, status, err.toString());
					}.bind(this)
				});			
			},
			handleCommentSubmit: function(comment){
				var comments = this.state.data;
				var newComments = comments.concat([comment]);
				this.setState({data: newComments});
				$.ajax({
					url: this.props.url,
					dataType:"json",
					type:"POST",
					data:comment,
					success: function(data){
						this.setState({data:data});
					}.bind(this),
					error: function(xhr, status, err){
						console.error(this.props.url, status, err.toString());
					}.bind(this)
				});
			},
			getInitialState: function() {
				return {data: []};
			},
			componentDidMount: function(){
				this.loadCommentsFromServer();
				setInterval(this.loadCommentsFromServer, this.props.pollInterval)
			},
    		render: function(){
    			return(
    				<div className="commentBox">
    				<h1>Comments</h1>
    				<CommentList data={this.state.data}/>
    				<CommentForm onCommentSubmit={this.handleCommentSubmit}/>
    				</div>
    			);
    		}
    	})

    	var CommentList = React.createClass({
    		render: function(){
    			var commentNodes = this.props.data.map(function(comment){
    				return(
    					<Comment author={comment.author}>
    						{comment.message}
    					</Comment>
    				);
    			});
				return(
					<div className="commentList">
						{commentNodes}
					</div>
				);
    		}
    	})

    	var CommentForm = React.createClass({
    		handleSubmit: function(e){
    			e.preventDefault();
    			var data ={
    				author: this.refs.author.value,
    				message: this.refs.message.value
    			}
    			if(!data){
    				return;
    			}
    			this.props.onCommentSubmit(data);
    			this.refs.author.value = "";
    			this.refs.message.value = "";
    			return
    		},
    		render: function(){
    			return(
    				<form className="commentForm" onSubmit={this.handleSubmit}>
    					<input type="text" placeholder="姓名" ref="author"/>
    					<input type="text" placeholder="說些什麼吧．．．" ref="message"/>
    					<input type="submit" value="送出"/>
    				</form>
    			);
    		}
    	})

    	var converter = new Showdown.converter();
    	var Comment = React.createClass({
    		render: function(){
    			var rawMarkup = converter.makeHtml(this.props.children.toString());
    			return(
    				<div className="comment">
    					<h2 className="commentAuthor">
    						{this.props.author}
    					</h2>
    					<span dangerouslySetInnerHTML={{__html: rawMarkup}} />
    				</div>
    			)
    		}
    	})

    	ReactDOM.render(<CommentBox url="comments.json" pollInterval={2000}/>, document.getElementById("container_3"))

        var ProductCategoryRow = React.createClass({
            render: function(){
                return (
                    <tr>
                        <th colSpan="2">{this.props.category}</th>
                    </tr>
                );
            }
        });

        var ProductRow = React.createClass({
            render: function(){
                var name = this.props.product.stocked ? this.props.product.name :
                <span style={{color: "red"}}>
                    {this.props.product.name}
                </span>;
                return(
                    <tr>
                        <td>{name}</td>
                        <td>{this.props.product.price}</td>
                    </tr>
                );
            }
        });

        var ProductTable = React.createClass({
            render: function(){
                var rows = [];
                var lastCategory = null;
                this.props.products.forEach(function(product){
                    if(product.name.indexOf(this.props.filterText) === -1 || (!product.stocked && this.props.inStockOnly)){
                        return;
                    }
                    if(product.category !== lastCategory){  //預設是null，先判斷是否為第一次遇到這個分類
                        rows.push(<ProductCategoryRow category={product.category} key={product.category} />);
                    }//是的話就加上分類的標頭，之後同一分類的就不再加上標頭
                    rows.push(<ProductRow product={product} key={product.name} />); //加入產品
                    lastCategory = product.category; //紀錄目前的分類，以判斷下一個項目是否為同一個分類
                }.bind(this));
                return(
                    <table>
                        <thead>
                            <tr>
                                <th>名稱</th>
                                <th>價格</th>
                            </tr>
                        </thead>
                        <tbody>{rows}</tbody>
                    </table>
                );
            }
        });

        var SearchBar = React.createClass({
            handleChange: function(){
                this.props.onUserInput(
                    this.refs.filterTextInput.value,
                    this.refs.inStockOnlyInput.checked
                );
            },
            render: function(){
                return(
                    <form>
                        <input type="text" 
                            placeholder="找什麼?" 
                            value={this.props.filterText}
                            ref="filterTextInput"
                            onChange={this.handleChange}/>
                        <p>
                            <input type="checkbox" 
                                checkbox={this.props.inStockOnly}
                                ref="inStockOnlyInput"
                                onChange={this.handleChange}/>
                            {' '}
                            only show products in stocked
                        </p>
                    </form>
                );
            }
        });

        var FilterableProductTable = React.createClass({
            getInitialState: function(){
                return{
                    filterText: "",
                    inStockOnly: false
                };
            },
            handleUserInput: function(filterText, inStockOnly){
                this.setState({
                    filterText: filterText,
                    inStockOnly: inStockOnly
                });
            },
            render: function(){
                return(
                    <div>
                        <SearchBar
                            filterText={this.state.filterText}
                            inStockOnly={this.state.inStockOnly}
                            onUserInput={this.handleUserInput} />
                        <ProductTable 
                            products={this.props.products} 
                            filterText={this.state.filterText}
                            inStockOnly={this.state.inStockOnly} />
                    </div>
                );
            }
        });

        var PRODUCTS = [
            {category: 'Sporting Goods', price: '$49.99', stocked: true, name: 'Football'},
            {category: 'Sporting Goods', price: '$9.99', stocked: true, name: 'Baseball'},
            {category: 'Sporting Goods', price: '$29.99', stocked: false, name: 'Basketball'},
            {category: 'Electronics', price: '$99.99', stocked: true, name: 'iPod Touch'},
            {category: 'Electronics', price: '$399.99', stocked: false, name: 'iPhone 5'},
            {category: 'Electronics', price: '$199.99', stocked: true, name: 'Nexus 7'}
        ];

        ReactDOM.render(<FilterableProductTable products={PRODUCTS} />, document.getElementById("container_4"));

        var LikeButton = React.createClass({
            getInitialState: function(){
                return{liked: false};
            },
            handleClick: function(){
                this.setState({liked: !this.state.liked});
            },
            render: function(){
                var text = this.state.liked ? "喜歡" : "不喜歡" ;
                return(
                    <p onClick={this.handleClick}>
                    你【{text}】。<br/>點擊切換
                    </p>
                );
            }
        });
        ReactDOM.render(<LikeButton/> , document.getElementById("container_5"));

        var SetIntervalMixin = {
            componentWillMount: function(){
                this.intervals = [];
            },
            setInterval: function(){
                this.intervals.push( setInterval.apply(null, arguments) );
            },
            componentWillUnmount: function(){
                this.intervals.map( clearInterval );
            },
            handleStop: function(){
                this.intervals.map( clearInterval );
            }
        };

        var TickTock = React.createClass({
            mixins: [SetIntervalMixin],//引用mixin
            getInitialState: function(){
                return{
                    seconds: 0,
                    clickState: false
                };
            },
            componentDidMount: function(){
                this.setInterval(this.tick, 1000);//調用mixin的方法
            },
            tick: function(){
                this.setState({seconds: this.state.seconds + 1});
            },
            handleClick: function(){             
                if(this.state.clickState){
                    this.setInterval(this.tick, 1000);
                }else{
                    this.handleStop();                   
                }

                this.setState({clickState: !this.state.clickState});
            },
            render: function(){
                return(
                    <p onClick={this.handleClick}>
                    {this.state.seconds} second.
                    <br/>點擊【繼續/停止】計數
                    </p>
                );
            }
        });

        ReactDOM.render(<TickTock/>, document.getElementById("container_6"));

        var FancyCheckbox = React.createClass({
            getInitialState: function(){
                return{ checked:true}
            },
            handleClick: function(){
                this.setState({ checked: !this.state.checked});
            },
            render: function(){
                var {title, ...other} = this.props;
                var fancyClass = this.state.checked ? "FancyChecked" : "FancyUnchecked" ;
                var fancyTitle = this.state.checked ? "X" + title : "O" + title;
                return(
                    <label>
                        <input {...other} 
                        checked={this.state.checked} 
                        className={fancyClass} 
                        type="checkbox" 
                        onClick={this.handleClick}/>
                        {fancyTitle}
                    </label>
                );
            }
        });

        ReactDOM.render(
            <FancyCheckbox title="嗯?Tilte?">
                Hello World!
            </FancyCheckbox>, document.getElementById("container_7")
        )

        var MyComponent = React.createClass({
            handleClick: function(){
                this.refs.myTextInput.focus();
            },
            render: function(){
                return(
                <div>
                    <input type="text" ref="myTextInput" />
                    <input type="button" value="Focus the text input"
                            onClick={this.handleClick} />
                </div>                   
                );

            }
        });
        ReactDOM.render(<MyComponent/>, document.getElementById("container_8"));
    </script>
</html>